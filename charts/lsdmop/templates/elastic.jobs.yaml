{{- if .Values.lsdmop.elastic.enabled -}}
---
apiVersion: batch/v1
kind: Job
metadata:
  name: elastic-post-setup
  namespace: {{ .Release.Namespace }}
  annotations:
    "helm.sh/hook": post-install,post-upgrade
  # annotations:
  #   "helm.sh/hook": post-install
spec:
  template:
    spec:
      #VOLUMES FOR CONFIG MAPS for all initcontainers
      restartPolicy: Never
      volumes:
      - configMap:
          defaultMode: 420
          name: elastic-filebeat-custom-files
        name: elastic-filebeat-custom-files     

      initContainers:
      #WAIT FOR ELASTIC TO START ACCEPTING API CALLS
      - args:
        - /bin/sh
        - -c
        - |
          set -x; while [ "$(curl -u elastic:$ELASTIC_PASSWORD -ks https://lsdmop-es-http:9200/_cluster/health?pretty | grep status | sed -r 's/^[^:]*:(.*),+$/\1/' | sed -r 's/[[:space:]\"]*//g')" != "green" ]; do
            sleep 5;
          done;
          sleep 60;
        env:
          - name: ELASTIC_PASSWORD
            valueFrom:
              secretKeyRef:
                name: lsdmop-es-elastic-user
                key: elastic
        image: {{ .Values.lsdmop.curl.image }}
        name: wait-for-elastic
      containers:

      #DEBUG SLEEP CONTAINER
      - args:
        - -c
        - "sleep 1"
        command:
        - /bin/sh
        env:
          - name: ELASTIC_PASSWORD
            valueFrom:
              secretKeyRef:
                name: lsdmop-es-elastic-user
                key: elastic
        image: {{ .Values.lsdmop.curl.image }}
        name: sleep-debug-container
        volumeMounts:
        - mountPath: /opt/elastic/
          name: elastic-filebeat-custom-files


      #BOOTSTRAP PLATFORM MONITORING FLEET POLICY
      - args:
        - -c
        - "curl -skv -u elastic:$ELASTIC_PASSWORD -XPOST https://lsdmop-kb-http:5601/api/fleet/agent_policies?sys_monitoring=true -H \"kbn-xsrf: reporting\" -H \"Content-Type: application/json\" -d'{\"name\": \"elastic-platform-monitoring\",\"description\": \"A policy for monitoring core platform components.\",\"namespace\": \"platformmonitoring\",\"monitoring_enabled\": [],\"inactivity_timeout\": 1209600,\"is_protected\": false}'"
        command:
        - /bin/sh
        env:
          - name: ELASTIC_PASSWORD
            valueFrom:
              secretKeyRef:
                name: lsdmop-es-elastic-user
                key: elastic
        image: {{ .Values.lsdmop.curl.image }}
        name: elastic-platform-monitoring-fleet-policy
        volumeMounts:
        - mountPath: /opt/elastic/
          name: elastic-filebeat-custom-files
          
          #RESPONSE
          # {
          #   "item": {
          #     "id": "1eb868b0-c0f0-11ee-9fa4-2d44c26abe95",
          #     "name": "example",
          #     "description": "",
          #     "namespace": "platformmonitoring",
          #     "monitoring_enabled": [],
          #     "inactivity_timeout": 1209600,
          #     "is_protected": false,
          #     "status": "active",
          #     "is_managed": false,
          #     "revision": 1,
          #     "updated_at": "2024-02-01T10:53:23.521Z",
          #     "updated_by": "elastic",
          #     "schema_version": "1.1.1"
          #   }
          # }


      #BOOTSTRAP PLATFORM MONITORING FLEET ES INTEGRATION
      - args:
        - -c
        - "curl -skv -u elastic:$ELASTIC_PASSWORD -XPOST https://lsdmop-kb-http:5601/api/fleet/package_policies?sys_monitoring=true -H \"kbn-xsrf: reporting\" -H \"Content-Type: application/json\" -d'{ \"policy_id\": \"141ef470-c0e9-11ee-ba45-795e21db46d1\", \"package\": { \"name\": \"elasticsearch\", \"version\": \"1.13.1\" }, \"name\": \"elasticsearch-1\", \"description\": \"\", \"namespace\": \"platform\", \"inputs\": { \"elasticsearch-logfile\": { \"enabled\": true, \"vars\": {}, \"streams\": {  \"elasticsearch.audit\": {  \"enabled\": true,  \"vars\": {  \"paths\": [  \"/var/log/elasticsearch/*_audit.json\"  ]  }  },  \"elasticsearch.deprecation\": {  \"enabled\": true,  \"vars\": {  \"paths\": [  \"/var/log/elasticsearch/*_deprecation.json\"  ]  }  },  \"elasticsearch.gc\": {  \"enabled\": true,  \"vars\": {  \"paths\": [  \"/var/log/elasticsearch/gc.log.[0-9]*\",  \"/var/log/elasticsearch/gc.log\"  ]  }  },  \"elasticsearch.server\": {  \"enabled\": true,  \"vars\": {  \"paths\": [  \"/var/log/elasticsearch/*_server.json\"  ]  }  },  \"elasticsearch.slowlog\": {  \"enabled\": true,  \"vars\": {  \"paths\": [  \"/var/log/elasticsearch/*_index_search_slowlog.json\",  \"/var/log/elasticsearch/*_index_indexing_slowlog.json\"  ]  }  } } }, \"elasticsearch-elasticsearch/metrics\": { \"enabled\": true, \"vars\": {  \"hosts\": [  \"http://localhost:9200\"  ],  \"scope\": \"node\",  \"leaderelection\": false }, \"streams\": {  \"elasticsearch.stack_monitoring.ccr\": {  \"enabled\": true,  \"vars\": {  \"period\": \"10s\"  }  },  \"elasticsearch.stack_monitoring.cluster_stats\": {  \"enabled\": true,  \"vars\": {  \"period\": \"10s\"  }  },  \"elasticsearch.stack_monitoring.enrich\": {  \"enabled\": true,  \"vars\": {  \"period\": \"10s\"  }  },  \"elasticsearch.stack_monitoring.index\": {  \"enabled\": true,  \"vars\": {  \"period\": \"10s\"  }  },  \"elasticsearch.stack_monitoring.index_recovery\": {  \"enabled\": true,  \"vars\": {  \"active.only\": true,  \"period\": \"10s\"  }  },  \"elasticsearch.stack_monitoring.index_summary\": {  \"enabled\": true,  \"vars\": {  \"period\": \"10s\"  }  },  \"elasticsearch.ingest_pipeline\": {  \"enabled\": true,  \"vars\": {  \"ingest_pipeline_processor_sampling_rate\": \"0.25\"  }  },  \"elasticsearch.stack_monitoring.ml_job\": {  \"enabled\": true,  \"vars\": {  \"period\": \"10s\"  }  },  \"elasticsearch.stack_monitoring.node\": {  \"enabled\": true,  \"vars\": {  \"period\": \"10s\"  }  },  \"elasticsearch.stack_monitoring.node_stats\": {  \"enabled\": true,  \"vars\": {  \"period\": \"10s\"  }  },  \"elasticsearch.stack_monitoring.pending_tasks\": {  \"enabled\": true,  \"vars\": {  \"period\": \"10s\"  }  },  \"elasticsearch.stack_monitoring.shard\": {  \"enabled\": true,  \"vars\": {  \"period\": \"10s\"  }  } } } } }'"
        command:
        - /bin/sh
        env:
          - name: ELASTIC_PASSWORD
            valueFrom:
              secretKeyRef:
                name: lsdmop-es-elastic-user
                key: elastic
        image: {{ .Values.lsdmop.curl.image }}
        name: elastic-platform-monitoring-fleet-es-integration
        volumeMounts:
        - mountPath: /opt/elastic/
          name: elastic-filebeat-custom-files


{{- if .Values.lsdmop.elastic.ad.enabled }}
      #ROLE MAPPINGS TO AD GROUPS
      - args:
        - -c
        - "curl -skv -u elastic:$ELASTIC_PASSWORD -H \"Content-Type: application/json\" -X PUT -d '{\"roles\" : [ \"user\" ],  \"rules\" : { \"field\" : { \"groups\" : \"{{ .Values.lsdmop.elastic.ad.userdn }}\" } },  \"enabled\": true}' https://lsdmop-es-http:9200/_security/role_mapping/basic_user"
        command:
        - /bin/sh
        env:
          - name: ELASTIC_PASSWORD
            valueFrom:
              secretKeyRef:
                name: lsdmop-es-elastic-user
                key: elastic
        image: {{ .Values.lsdmop.curl.image }}
        name: rolemapping-user
        volumeMounts:
        - mountPath: /opt/elastic/
          name: elastic-filebeat-custom-files


      - args:
        - -c
        - "curl -skv -u elastic:$ELASTIC_PASSWORD -H \"Content-Type: application/json\" -X PUT -d '{\"roles\" : [ \"superuser\" ],  \"rules\" : { \"field\" : { \"groups\" : \"{{ .Values.lsdmop.elastic.ad.admindn }}\" } },  \"enabled\": true }' https://lsdmop-es-http:9200/_security/role_mapping/admin_user"
        command:
        - /bin/sh
        env:
          - name: ELASTIC_PASSWORD
            valueFrom:
              secretKeyRef:
                name: lsdmop-es-elastic-user
                key: elastic
        image: {{ .Values.lsdmop.curl.image }}
        name: rolemapping-admin
        volumeMounts:
        - mountPath: /opt/elastic/
          name: elastic-filebeat-custom-files
{{- end }}




{{- if .Values.lsdmop.elastic.s3snapshot.enabled }}

      #LOAD S3 Repo Config for Snapshots    - must happen before ILM S3 policies see #ILM POLICIES WITH S3
      - args:
        - -c
        - "curl -kv -u elastic:$ELASTIC_PASSWORD -H \"Content-Type: application/json\" -X PUT -d '{\"type\": \"s3\",\"settings\": {\"bucket\": \"{{ .Values.lsdmop.elastic.s3snapshot.bucket }}\"}}' https://lsdmop-es-http.lsdmop.svc:9200/_snapshot/s3_repository"
        command:
        - /bin/sh
        env:
          - name: ELASTIC_PASSWORD
            valueFrom:
              secretKeyRef:
                name: lsdmop-es-elastic-user
                key: elastic
        image: {{ .Values.lsdmop.curl.image }}
        name: elastic-load-snapshot-repo
        volumeMounts:
        - mountPath: /opt/elastic/
          name: elastic-filebeat-custom-files


      #LOAD S3 Daily Policy Config for Snapshots    
      - args:
        - -c
        - "curl -kv -u elastic:$ELASTIC_PASSWORD -H \"Content-Type: application/json\" -X PUT -d @/opt/elastic/lsdmop-elastic-load-snapshot-policy-daily.ndjson https://lsdmop-es-http.lsdmop.svc:9200/_slm/policy/cluster-state-daily"
        command:
        - /bin/sh
        env:
          - name: ELASTIC_PASSWORD
            valueFrom:
              secretKeyRef:
                name: lsdmop-es-elastic-user
                key: elastic
        image: {{ .Values.lsdmop.curl.image }}
        name: elastic-load-snapshot-policy-daily
        volumeMounts:
        - mountPath: /opt/elastic/
          name: elastic-filebeat-custom-files


      #LOAD S3 Hourly Policy Config for Snapshots    
      - args:
        - -c
        - "curl -kv -u elastic:$ELASTIC_PASSWORD -H \"Content-Type: application/json\" -X PUT -d @/opt/elastic/lsdmop-elastic-load-snapshot-policy-hourly.ndjson https://lsdmop-es-http.lsdmop.svc:9200/_slm/policy/cluster-state-hourly"
        command:
        - /bin/sh
        env:
          - name: ELASTIC_PASSWORD
            valueFrom:
              secretKeyRef:
                name: lsdmop-es-elastic-user
                key: elastic
        image: {{ .Values.lsdmop.curl.image }}
        name: elastic-load-snapshot-policy-hourly
        volumeMounts:
        - mountPath: /opt/elastic/
          name: elastic-filebeat-custom-files   
{{- end }}



{{- if .Values.lsdmop.elastic.s3snapshot.enabled }}
      #ILM POLICIES WITH S3
      - args:
        - -c
        - "curl -skv -u elastic:$ELASTIC_PASSWORD -H 'Content-Type: application/json' -X PUT -d @/opt/elastic/lsdmop-filebeat.ilm.policy.infra.s3.json \"https://lsdmop-es-http:9200/_ilm/policy/logs-infra\""
        command:
        - /bin/sh
        env:
          - name: ELASTIC_PASSWORD
            valueFrom:
              secretKeyRef:
                name: lsdmop-es-elastic-user
                key: elastic
        image: {{ .Values.lsdmop.curl.image }}
        name: filebeat-ilm-policy-infra
        volumeMounts:
        - mountPath: /opt/elastic/
          name: elastic-filebeat-custom-files

      - args:
        - -c
        - "curl -skv -u elastic:$ELASTIC_PASSWORD -H 'Content-Type: application/json' -X PUT -d @/opt/elastic/lsdmop-filebeat.ilm.policy.lsdo.s3.json \"https://lsdmop-es-http:9200/_ilm/policy/logs-lsdmop\""
        command:
        - /bin/sh
        env:
          - name: ELASTIC_PASSWORD
            valueFrom:
              secretKeyRef:
                name: lsdmop-es-elastic-user
                key: elastic
        image: {{ .Values.lsdmop.curl.image }}
        name: filebeat-ilm-policy-lsdmop
        volumeMounts:
        - mountPath: /opt/elastic/
          name: elastic-filebeat-custom-files

      - args:
        - -c
        - "curl -skv -u elastic:$ELASTIC_PASSWORD -H 'Content-Type: application/json' -X PUT -d @/opt/elastic/lsdmop-filebeat.ilm.policy.apps.s3.json \"https://lsdmop-es-http:9200/_ilm/policy/logs-apps\""
        command:
        - /bin/sh
        env:
          - name: ELASTIC_PASSWORD
            valueFrom:
              secretKeyRef:
                name: lsdmop-es-elastic-user
                key: elastic
        image: {{ .Values.lsdmop.curl.image }}
        name: filebeat-ilm-policy-apps
        volumeMounts:
        - mountPath: /opt/elastic/
          name: elastic-filebeat-custom-files
{{- else}}
      #ILM POLICIES WITHOUT S3
      - args:
        - -c
        - "curl -skv -u elastic:$ELASTIC_PASSWORD -H 'Content-Type: application/json' -X PUT -d @/opt/elastic/lsdmop-filebeat.ilm.policy.infra.json \"https://lsdmop-es-http:9200/_ilm/policy/logs-infra\""
        command:
        - /bin/sh
        env:
          - name: ELASTIC_PASSWORD
            valueFrom:
              secretKeyRef:
                name: lsdmop-es-elastic-user
                key: elastic
        image: {{ .Values.lsdmop.curl.image }}
        name: filebeat-ilm-policy-infra
        volumeMounts:
        - mountPath: /opt/elastic/
          name: elastic-filebeat-custom-files

      - args:
        - -c
        - "curl -skv -u elastic:$ELASTIC_PASSWORD -H 'Content-Type: application/json' -X PUT -d @/opt/elastic/lsdmop-filebeat.ilm.policy.lsdo.json \"https://lsdmop-es-http:9200/_ilm/policy/logs-lsdmop\""
        command:
        - /bin/sh
        env:
          - name: ELASTIC_PASSWORD
            valueFrom:
              secretKeyRef:
                name: lsdmop-es-elastic-user
                key: elastic
        image: {{ .Values.lsdmop.curl.image }}
        name: filebeat-ilm-policy-lsdmop
        volumeMounts:
        - mountPath: /opt/elastic/
          name: elastic-filebeat-custom-files

      - args:
        - -c
        - "curl -skv -u elastic:$ELASTIC_PASSWORD -H 'Content-Type: application/json' -X PUT -d @/opt/elastic/lsdmop-filebeat.ilm.policy.apps.json \"https://lsdmop-es-http:9200/_ilm/policy/logs-apps\""
        command:
        - /bin/sh
        env:
          - name: ELASTIC_PASSWORD
            valueFrom:
              secretKeyRef:
                name: lsdmop-es-elastic-user
                key: elastic
        image: {{ .Values.lsdmop.curl.image }}
        name: filebeat-ilm-policy-apps
        volumeMounts:
        - mountPath: /opt/elastic/
          name: elastic-filebeat-custom-files
{{- end}}


      #COMPONENT TEMPLATES    
      - args:
        - -c
        - "curl -skv -u elastic:$ELASTIC_PASSWORD -H 'Content-Type: application/json' -X PUT -d @/opt/elastic/lsdmop-filebeat.template.8.4.1.json \"https://lsdmop-es-http:9200/_component_template/filebeat-8.4.1\""
        command:
        - /bin/sh
        
        env:
          - name: ELASTIC_PASSWORD
            valueFrom:
              secretKeyRef:
                name: lsdmop-es-elastic-user
                key: elastic
        image: {{ .Values.lsdmop.curl.image }}
        name: filebeat-component-template
        volumeMounts:
        - mountPath: /opt/elastic/
          name: elastic-filebeat-custom-files

      - args:
        - -c
        - "curl -skv -u elastic:$ELASTIC_PASSWORD -H 'Content-Type: application/json' -X PUT -d @/opt/elastic/lsdmop-filebeat.component.template.infra.json \"https://lsdmop-es-http:9200/_component_template/filebeat-infra\""
        command:
        - /bin/sh
        env:
          - name: ELASTIC_PASSWORD
            valueFrom:
              secretKeyRef:
                name: lsdmop-es-elastic-user
                key: elastic
        image: {{ .Values.lsdmop.curl.image }}
        name: filebeat-component-template-infra
        volumeMounts:
        - mountPath: /opt/elastic/
          name: elastic-filebeat-custom-files

      - args:
        - -c
        - "curl -skv -u elastic:$ELASTIC_PASSWORD -H 'Content-Type: application/json' -X PUT -d @/opt/elastic/lsdmop-filebeat.component.template.lsdo.json \"https://lsdmop-es-http:9200/_component_template/filebeat-lsdmop\""
        command:
        - /bin/sh
        env:
          - name: ELASTIC_PASSWORD
            valueFrom:
              secretKeyRef:
                name: lsdmop-es-elastic-user
                key: elastic
        image: {{ .Values.lsdmop.curl.image }}
        name: filebeat-component-template-lsdmop
        volumeMounts:
        - mountPath: /opt/elastic/
          name: elastic-filebeat-custom-files

      - args:
        - -c
        - "curl -skv -u elastic:$ELASTIC_PASSWORD -H 'Content-Type: application/json' -X PUT -d @/opt/elastic/lsdmop-filebeat.component.template.apps.json \"https://lsdmop-es-http:9200/_component_template/filebeat-apps\""
        command:
        - /bin/sh
        env:
          - name: ELASTIC_PASSWORD
            valueFrom:
              secretKeyRef:
                name: lsdmop-es-elastic-user
                key: elastic
        image: {{ .Values.lsdmop.curl.image }}
        name: filebeat-component-template-apps
        volumeMounts:
        - mountPath: /opt/elastic/
          name: elastic-filebeat-custom-files 




      #COMPONENTISED INDEX TEMPLATES
      - args:
        - -c
        - "curl -skv -u elastic:$ELASTIC_PASSWORD -H 'Content-Type: application/json' -X PUT -d @/opt/elastic/lsdmop-filebeat.template.apps.json \"https://lsdmop-es-http:9200/_index_template/filebeat-apps\""
        command:
        - /bin/sh
        env:
          - name: ELASTIC_PASSWORD
            valueFrom:
              secretKeyRef:
                name: lsdmop-es-elastic-user
                key: elastic
        image: {{ .Values.lsdmop.curl.image }}
        name: filebeat-template-apps
        volumeMounts:
        - mountPath: /opt/elastic/
          name: elastic-filebeat-custom-files 

      - args:
        - -c
        - "curl -skv -u elastic:$ELASTIC_PASSWORD -H 'Content-Type: application/json' -X PUT -d @/opt/elastic/lsdmop-filebeat.template.lsdo.json \"https://lsdmop-es-http:9200/_index_template/filebeat-lsdmop\""
        command:
        - /bin/sh
        env:
          - name: ELASTIC_PASSWORD
            valueFrom:
              secretKeyRef:
                name: lsdmop-es-elastic-user
                key: elastic
        image: {{ .Values.lsdmop.curl.image }}
        name: filebeat-template-lsdmop
        volumeMounts:
        - mountPath: /opt/elastic/
          name: elastic-filebeat-custom-files 

      - args:
        - -c
        - "curl -skv -u elastic:$ELASTIC_PASSWORD -H 'Content-Type: application/json' -X PUT -d @/opt/elastic/lsdmop-filebeat.template.infra.json \"https://lsdmop-es-http:9200/_index_template/filebeat-infra\""
        command:
        - /bin/sh
        env:
          - name: ELASTIC_PASSWORD
            valueFrom:
              secretKeyRef:
                name: lsdmop-es-elastic-user
                key: elastic
        image: {{ .Values.lsdmop.curl.image }}
        name: filebeat-template-infra
        volumeMounts:
        - mountPath: /opt/elastic/
          name: elastic-filebeat-custom-files 

      # BOOTSTRAP DATASTREAMS  PUT _data_stream/my-data-stream
      - args:
        - -c
        - "curl -skv -u elastic:$ELASTIC_PASSWORD -H 'Content-Type: application/json' -X PUT \"https://lsdmop-es-http:9200/_data_stream/filebeat-8.4.1-infra\""
        command:
        - /bin/sh
        env:
          - name: ELASTIC_PASSWORD
            valueFrom:
              secretKeyRef:
                name: lsdmop-es-elastic-user
                key: elastic
        image: {{ .Values.lsdmop.curl.image }}
        name: filebeat-bootstrap-infra
        volumeMounts:
        - mountPath: /opt/elastic/
          name: elastic-filebeat-custom-files

      - args:
        - -c
        - "curl -skv -u elastic:$ELASTIC_PASSWORD -H 'Content-Type: application/json' -X PUT \"https://lsdmop-es-http:9200/_data_stream/filebeat-8.4.1-lsdmop\""
        command:
        - /bin/sh
        env:
          - name: ELASTIC_PASSWORD
            valueFrom:
              secretKeyRef:
                name: lsdmop-es-elastic-user
                key: elastic
        image: {{ .Values.lsdmop.curl.image }}
        name: filebeat-bootstrap-lsdmop
        volumeMounts:
        - mountPath: /opt/elastic/
          name: elastic-filebeat-custom-files
          
      - args:
        - -c
        - "curl -skv -u elastic:$ELASTIC_PASSWORD -H 'Content-Type: application/json' -X PUT \"https://lsdmop-es-http:9200/_data_stream/filebeat-8.4.1-apps\""
        command:
        - /bin/sh
        env:
          - name: ELASTIC_PASSWORD
            valueFrom:
              secretKeyRef:
                name: lsdmop-es-elastic-user
                key: elastic
        image: {{ .Values.lsdmop.curl.image }}
        name: filebeat-bootstrap-apps
        volumeMounts:
        - mountPath: /opt/elastic/
          name: elastic-filebeat-custom-files


      #LOAD DASHBOARDS    
      - args:
        - -c
        - "curl -kv -u elastic:$ELASTIC_PASSWORD -H \"kbn-xsrf: true\" -X POST --form file=@/opt/elastic/lsdmop-elastic-load-sample-dashboard.ndjson https://lsdmop-kb-http:5601/api/saved_objects/_import?createNewCopies=false"
        command:
        - /bin/sh
        env:
          - name: ELASTIC_PASSWORD
            valueFrom:
              secretKeyRef:
                name: lsdmop-es-elastic-user
                key: elastic
        image: {{ .Values.lsdmop.curl.image }}
        name: elastic-load-sample-dashboard
        volumeMounts:
        - mountPath: /opt/elastic/
          name: elastic-filebeat-custom-files

      #SPACE ALERT GENERATOR
      - args:
        - -c
        - "echo ''"
        command:
        - /bin/sh
        env:
          - name: ELASTIC_PASSWORD
            valueFrom:
              secretKeyRef:
                name: lsdmop-es-elastic-user
                key: elastic
        image: {{ .Values.lsdmop.curl.image }}
        name: elastic-space-alert-generator
        volumeMounts:
        - mountPath: /opt/elastic/
          name: elastic-filebeat-custom-files








---
{{- end }}
